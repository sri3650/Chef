#!/bin/sh

RAILS_ENV=`/usr/local/chronus/bin/rails_env`


if [ -x /mnt/app/current ] ; then
  for f in `ls /mnt/app/current/log/*.log` ; do
    logfile=$f-`date +%Y%m%d`
    if [ -e $logfile ] ; then
      gzip $logfile
      /usr/local/chronus/bin/archive_file.rb --file $logfile.gz --dir logs/rails && rm $logfile.gz
    fi
  done

fi

if [ -e /mnt/log/nginx/access.log ] ; then
  for f in `ls /mnt/log/nginx/*.log` ; do
    logfile=$f-`date +%Y%m%d`
    if [ -e $logfile ] ; then
      gzip $logfile
      /usr/local/chronus/bin/archive_file.rb --file $logfile.gz --dir logs/nginx && rm $logfile.gz
    fi
  done
fi

if [ -e /mnt/log/redis.log ] ; then
  logfile=/mnt/log/redis.log-`date +%Y%m%d`
  if [ -e $logfile ] ; then
    gzip $logfile
    /usr/local/chronus/bin/archive_file.rb --file $logfile.gz --dir logs/redis && rm $logfile.gz
  fi
fi

if [ -x /var/log/mysql ] ; then
  for f in `ls /var/log/mysql/*.log` ; do
    logfile=$f-`date +%Y%m%d`
    if [ -e $logfile ] ; then
      gzip $logfile
      /usr/local/chronus/bin/archive_file.rb --file $logfile.gz --dir logs/mysql && rm $logfile.gz
    fi
  done
fi

if [ -e /mnt/log/syslog ] ; then
  logfile=/mnt/log/syslog-`date +%Y%m%d`
  if [ -e $logfile ]; then
    gzip $logfile
    /usr/local/chronus/bin/archive_file.rb --file $logfile.gz --dir logs/rails && rm $logfile.gz
  fi
fi

if [ -d /mnt/app/current/config/locales ] ; then
    tar -zcf locales-`date +%Y%m%d`.tar.gz /mnt/app/current/config/locales
    /usr/local/chronus/bin/archive_file.rb --file locales-`date +%Y%m%d`.tar.gz --dir locales && rm "locales-`date +%Y%m%d`.tar.gz"
fi